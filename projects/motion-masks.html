
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="David Thomas">
  <meta name="keywords" content="DaveSpace, David Thomas, Dave Thomas">
  <meta name="description" content="David Thomas's website.">

  <title>Projects: Motion Masks | DaveSpace</title>

  <link rel="icon" type="image/vnd.microsoft.icon" href="../favicon.ico" />
  <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../favicon.ico" />

  <link rel="stylesheet" type="text/css" href="../style/flat.css">

  <link rel="alternate" type="application/atom+xml" title="DaveSpace feed" href="../blog.atom">

  <script src="https://kit.fontawesome.com/9bf331e7d1.js" crossorigin="anonymous"></script>
</head>
<body id="projects">

  <div id="header">
    <h1><i class="fas fa-user-astronaut"></i> <a href="../">DaveSpace</a></h1>
  </div>

  <div id="nav">
    

<h1>Projects</h1>
<ul class="fa-ul">
  
  <li><i class="fa-li far fa-circle"></i> <a href="../projects/">Overview</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../projects/containers.html">Containers</a></li>
  
  <li><i class="fa-li fa fa-circle"></i> <a href="../projects/motion-masks.html">Motion Masks</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../projects/lego-wedding-arch.html">A LEGO® Wedding Arch</a></li>
  
</ul>


    
<h1>Categories</h1>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../arm/">ARM</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../doodles/">Doodles</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../projects/">Projects</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../python/">Python</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../risc.os/">RISC&nbsp;OS</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../the.great.escape/">The&nbsp;Great&nbsp;Escape</a></li>
</ul>

    
<h1>Tags</h1>
<p><a href="../tags/ARM.html">ARM</a> <a href="../tags/Blog.html">Blog</a> <a href="../tags/RISC OS.html">RISC OS</a> <a href="../tags/PrivateEye.html">PrivateEye</a> <a href="../tags/PhotoFiler.html">PhotoFiler</a> <a href="../tags/Geminus.html">Geminus</a> <a href="../tags/IntroductionToARM.html">IntroductionToARM</a> <a href="../tags/Toolbar.html">Toolbar</a> <a href="../tags/Site.html">Site</a> <a href="../tags/Project.html">Project</a> <a href="../tags/Containers.html">Containers</a> <a href="../tags/GitHub.html">GitHub</a> <a href="../tags/Hardware.html">Hardware</a> <a href="../tags/iOS.html">iOS</a> <a href="../tags/Optimisation.html">Optimisation</a> <a href="../tags/Aha.html">Aha</a> <a href="../tags/Retro.html">Retro</a> <a href="../tags/Links.html">Links</a> <a href="../tags/Dump.html">Dump</a> <a href="../tags/Spectrum.html">Spectrum</a> <a href="../tags/Risc PC.html">Risc PC</a> <a href="../tags/The Great Escape.html">The Great Escape</a> <a href="../tags/Reverse Engineering.html">Reverse Engineering</a> <a href="../tags/LEGO.html">LEGO</a> <a href="../tags/Wedding.html">Wedding</a> <a href="../tags/Acorn.html">Acorn</a> <a href="../tags/Doodle.html">Doodle</a> <a href="../tags/Blender.html">Blender</a> <a href="../tags/3D.html">3D</a> <a href="../tags/Isometric.html">Isometric</a> <a href="../tags/2D.html">2D</a> <a href="../tags/Article.html">Article</a> <a href="../tags/Sinclair.html">Sinclair</a> <a href="../tags/Ocean.html">Ocean</a> <a href="../tags/Disassembly.html">Disassembly</a> <a href="../tags/Chase H.Q..html">Chase H.Q.</a> <a href="../tags/Tip.html">Tip</a> <a href="../tags/TargetedOptimisation.html">TargetedOptimisation</a> <a href="../tags/Archimedes.html">Archimedes</a> <a href="../tags/Logo.html">Logo</a> <a href="../tags/BasicOptimisation.html">BasicOptimisation</a> <a href="../tags/Slide.html">Slide</a> <a href="../tags/Trace.html">Trace</a> <a href="../tags/Hard Disc.html">Hard Disc</a> <a href="../tags/Vector.html">Vector</a> <a href="../tags/Recreation.html">Recreation</a> <a href="../tags/Pixel Art.html">Pixel Art</a> <a href="../tags/Groening.html">Groening</a> <a href="../tags/Simpsons.html">Simpsons</a> <a href="../tags/Futurama.html">Futurama</a> <a href="../tags/Disenchantment.html">Disenchantment</a> <a href="../tags/BBC Micro.html">BBC Micro</a> <a href="../tags/Electron.html">Electron</a> <a href="../tags/MotionMasks.html">MotionMasks</a> <a href="../tags/Script.html">Script</a> <a href="../tags/Python.html">Python</a> <a href="../tags/Iyonix.html">Iyonix</a> <a href="../tags/QuickFiler.html">QuickFiler</a> <a href="../tags/Game.html">Game</a> <a href="../tags/EfficientC.html">EfficientC</a> </p>


    
<h1>About me</h1>
<ul class="fa-ul">
  <li><i class="fa-li fas fa-user-astronaut"></i> David Thomas</li>
  <li><i class="fa-li fa fa-wrench"></i> Software Engineer</li>
  <li><i class="fa-li fas fa-map-pin"></i> Glasgow, Scotland</li>
</ul>

<h2>Contact</h2>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-envelope"></i> Email<br/> <a href="mailto:dave@davespace.co.uk">dave@davespace.co.uk</a></li>
  <li><i class="fa-li fab fa-github"></i> GitHub<br/> <a href="https://github.com/dpt">dpt</a></li>
  <li><i class="fa-li fab fa-youtube"></i> YouTube<br/> <a href="https://www.youtube.com/@bagospanners">@bagospanners</a></li>
</ul>

  </div>

<!-- start page -->

<!-- start post -->
<article>
  <header>
    <!-- start post header -->
    <h1><i class="fa fa-star"></i> Projects > Motion Masks</h1>
    
<!-- start meta -->
<div class="meta">
  by <span class="author">David Thomas</span> on <time datetime="2013-03-24T00:00:00Z">24 March 2013</time> &mdash;
  <ul>
    <li><i class="fa fa-tag"></i> <a href="../tags/GitHub.html">GitHub</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/Project.html">Project</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/MotionMasks.html">MotionMasks</a></li>

  </ul>
</div>
<!-- end meta -->

    <!-- end post header -->
  </header>

  
  <!-- start post content -->
  <section class="content">
    <p>Bitmap compositing driven by RLE-compressed alpha masks.</p>

<p><a href="https://github.com/dpt/MotionMasks">https://github.com/dpt/MotionMasks</a></p>

<p>Keywords: RLE alpha animation bitmap blend buffer clip clipping compact composite compressed framebuffer mask motion opacity stencil transition transparency wipe</p>

<h2>The Idea</h2>

<p>Let&rsquo;s say you have two static images:</p>

<p><img src="momask/inputs.png" alt="Two static images."></p>

<p>and you want to create an animated transition between them. For example, a fade:</p>

<p><img src="momask/fade.png" alt="Fade."></p>

<p>or a wipe:</p>

<p><img src="momask/wipe.png" alt="Wipe."></p>

<p>To describe each frame of the animation you could use a third image to specify at every pixel which source image to use. The &ldquo;lowest&rdquo; pixel value would mean select the corresponding pixel from the first image, the &ldquo;highest&rdquo; pixel value would mean select from the second image. Other pixel values would output a blend of the two respective input pixels.</p>

<p>Using green to represent &ldquo;high&rdquo; and black for &ldquo;low&rdquo;, the masks for our fade example would be:</p>

<p><img src="momask/fademask.png" alt="Fade mask."></p>

<p>and our wipe:</p>

<p><img src="momask/wipemask.png" alt="Wipe mask."></p>

<p>Of course, this is will be wasteful: the animation&rsquo;s frames are likely to be &lsquo;sparse&rsquo;, containing long runs of identical intensity but few &lsquo;edge&rsquo; pixels.</p>

<p>The sparseness of individual scanlines means that they are ideal for adaptive RLE compression. This saves space and when rendering would save waiting over and over for RAM fetches. The compression, in effect, makes use of wasted CPU cycles to provide faster RAM access.</p>

<p>Additionally, many entire scanlines will be identical, especially when considering all frames in the animation. We can therefore factor out identical scanlines by considering a frame to be compressed scanlines indirected through a table of offsets.</p>

<p>Now with our offsets and compressed scanlines we can render the animation by stepping through the offsets and plotting pixels as directed by the compressed scanline data.</p>

<h2>Compression</h2>

<p>The compression method used is RLE. This is simple enough to not require any heavy grunt work while plotting, but small enough to allow memory bandwidth requirements to be reduced.</p>

<h3>Compression Method</h3>

<ol>
<li>All of the input bitmaps are loaded.</li>
<li>Each scanline is numbered and hashed then recorded in an array.</li>
<li>The array is sorted into (hash, bitmap index, scanline index) order.</li>
<li>Duplicates scanlines are discarded.</li>
<li>Non-duplicates are encoded and packed into a data buffer, offsets retained.</li>
</ol>

<h2>Rendering</h2>

<p>This is just like a regular bitmap plot except that each row decodes a sequence of commands. The commands specify whether to plot, or blend between the corresponding two source image pixels and plot the result.</p>

<p>Two source images are available concurrently. The copy command can select either, the blend commands implicitly use both.</p>

<p>Other commands exist, such as one which selects the respective source images for copies and blends.</p>

<h2>Bitmaps &amp; Screens</h2>

<p>The Motion Mask code provides its own abstractions for bitmaps, screens and pixel formats, rather than operating on OS-specific types:</p>

<ul>
<li><code>bitmap_t</code></li>
<li><code>screen_t</code></li>
</ul>

<p>There is also a <code>bitmap_set_t</code> which is just like a <code>bitmap_t</code> but provides for multiple base pointers, allowing a series of images with identical dimensions and depth to be specified.</p>

<h2>Pixel Formats</h2>

<p>Pixel formats are specified with a <code>pixelfmt_t</code>. This enumeration has many pixels formats but only two are implemented so far: <code>rgbx8888</code> and <code>xbgr8888</code>.</p>

<h2>Pixel Handlers</h2>

<p>The copying and blending of specific pixel formats are coded in a <code>span_t</code>.</p>

<h2>Source Code Organisation</h2>

<ul>
<li>Platform independent code lives in <code>include</code> and <code>libraries</code>.</li>
<li><code>include</code> contains only public headers.</li>
<li><code>libraries</code> contains private headers and source code.</li>
<li>Platform-specific code lives in <code>platform</code>.</li>
</ul>

<h2>Building the Test App</h2>

<p>The core is generic, but the test app only exists for OS X presently.</p>

<ul>
<li>Open <code>platform/macos/MotionMasks/MotionMasks.xcodeproj</code>.<br></li>
<li>You&rsquo;ll need to adjust the file paths at the top of <code>MMCommon.h</code> to point to some 320x480 images. It&rsquo;s hardcoded at the moment. Sorry about that. It&rsquo;s early days. It&rsquo;ll get fixed. Maybe.</li>
<li>Run that. It&rsquo;ll open up a window which composites as you move the mouse around.</li>
</ul>

<h2>Notes</h2>

<ul>
<li>Written in straight C (no C99-isms, I think, save for the stdint types.)</li>
<li>Portable across OSes.</li>
<li>Tested on 32-bit and 64-bit [Note: presently there are hacks in there for 64-bit.]</li>
<li>Intended to have critical pixel-blending portions coded in assembly for speed.</li>
<li>Intended for embedded use where no GPU available.</li>
<li>Cocoa test app seems a painful way to get bitmaps on-screen. It&rsquo;s very slow.</li>
<li>Limits - two images per-pixel, sixteen source images which can be selected mid-stream.</li>
<li>Streams - abstracted loading mechanism.</li>
<li>It&rsquo;s easy to make upside-down bitmaps (just flip rowbytes and set the base pointer to the start of the last scanline.)</li>
<li>64K limit on data.</li>
</ul>

<h2>Current Status</h2>

<ul>
<li>Compression works.</li>
<li>Rendering works.</li>
</ul>

<p>There is an OS X Cocoa test app (&ldquo;MotionMaskTest&rdquo;) in <code>platform/macos</code> which loads a PNG from a (presently hard coded) location. This is packed into a Motion Mask and written out to disc. It&rsquo;s then loaded back in and some JPEGs are loaded and displayed through the Motion Mask. The mouse can be moved around the window to draw at different offsets.</p>

<h2>File Format</h2>

<h3>Header</h3>

<p>&hellip;</p>

<h3>Frames</h3>

<p>&hellip;</p>

<h3>Offsets</h3>

<p>&hellip;</p>

<h3>Data</h3>

<p>&hellip;</p>

<h2>Binary Encoding</h2>

<p>The count of leading zeros of the initial byte is the unique identifier of the operation.</p>

<p>Syntax:</p>

<ul>
<li><code>L</code> is a length bit,</li>
<li><code>A</code> is an alpha bit,</li>
<li><code>T</code> and <code>S</code> are source index bits,</li>
<li><code>x</code> is undefined.</li>
</ul>

<table>
<thead>
<tr>
<th>Command</th>
<th>Binary format</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Copy</td>
<td><code>1SLLLLLL</code></td>
<td>Copy from source <code>S</code> 1..64 pixels.</td>
</tr>

<tr>
<td>Blend const</td>
<td><code>01LLLLLL AAAAAAAA</code></td>
<td>Alpha blend 1..64 pixels with constant alpha.</td>
</tr>

<tr>
<td>Blend array</td>
<td><code>001LLLLL AAAAAAAA[len]</code></td>
<td>Alpha blend 1..32 pixels with variable alpha.</td>
</tr>

<tr>
<td>Long copy</td>
<td><code>0001SLLL LLLLLLLL</code></td>
<td>Copy from source <code>S</code> 65..2112 pixels.</td>
</tr>

<tr>
<td>Long blend const</td>
<td><code>00001LLL LLLLLLLL AAAAAAAA</code></td>
<td>Alpha blend 65..2112 pixels with constant alpha.</td>
</tr>

<tr>
<td>Long blend array</td>
<td><code>000001LL LLLLLLLL AAAAAAAA[len]</code></td>
<td>Alpha blend 33..1056 pixels with variable alpha.</td>
</tr>

<tr>
<td>Set source</td>
<td><code>0000001x TTTTSSSS</code></td>
<td>Set source images 0 and 1 to <code>S</code> and <code>T</code>. (Source zero is the screen, source N is input image N-1).</td>
</tr>

<tr>
<td>EOL</td>
<td><code>00000001</code></td>
<td>End of line.</td>
</tr>
</tbody>
</table>

<h2>To Do</h2>

<ul>
<li>Lots and lots!</li>
<li>Build environments for non-OS X platforms!</li>
<li>Regression tests!</li>
<li>Offsets ought to be RLE&rsquo;d! (They make up the bulk of the size of the Motion Mask).</li>
<li>Improve this documentation!</li>
<li>Doxygenate the codebase!</li>
<li>SetXY command! (To allow source image positions to be set).</li>
<li>Porter-Duff!</li>
<li>A library to support building custom Motion Masks from code!</li>
<li>Ragged right hand edges! (Motion Masks don&rsquo;t <em>need</em> to be square)</li>
</ul>

<h2>History</h2>

<ul>
<li>Get some animated stuff going! [done]</li>
</ul>

<h2>Other Projects with Similar Features</h2>

<ul>
<li><a href="http://alleg.sourceforge.net/">Allegro</a> has RLE sprites.</li>
<li><a href="http://www.libsdl.org/">SDL</a> has <code>SDL_RLEACCEL</code> to accelerate colour-keyed and alpha blits.</li>
</ul>

<h2>Author</h2>

<p>David Thomas <a href="mailto:dave@davespace.co.uk">dave@davespace.co.uk</a></p>

<h2>Copyright</h2>

<p>Copyright © David Thomas, 2012. All Rights Reserved.</p>

<p>[Licensing will be sorted out once the damn thing works].</p>

  </section>
  <!-- end post content -->

  
<!-- start flip -->

<!-- end flip -->

</article>
<!-- end post -->

<!-- end page -->

  <div id="footer">
    Copyright © David Thomas, 2005-2025<br/>
    Built using <i class="fab fa-github"></i> <a href="https://github.com/piranha/gostatic">gostatic</a> and <i class="fab fa-font-awesome-flag"></i> <a href="http://fontawesome.io/">Font Awesome</a>
  </div>
</body>
</html>

