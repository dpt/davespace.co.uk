
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="David Thomas">
  <meta name="keywords" content="DaveSpace, David Thomas, Dave Thomas">
  <meta name="description" content="David Thomas's website.">

  <title>The Great Escape: C Port | DaveSpace</title>

  <link rel="icon" type="image/vnd.microsoft.icon" href="../favicon.ico" />
  <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../favicon.ico" />

  <link rel="stylesheet" type="text/css" href="../style/flat.css">

  <link rel="alternate" type="application/atom+xml" title="DaveSpace feed" href="../blog.atom">

  <script src="https://kit.fontawesome.com/9bf331e7d1.js" crossorigin="anonymous"></script>
</head>
<body id="thegreatescape">

  <div id="header">
    <h1><i class="fas fa-user-astronaut"></i> <a href="../">DaveSpace</a></h1>
  </div>

  <div id="nav">
    

<h1>The Great Escape</h1>
<ul class="fa-ul">
  
  <li><i class="fa-li far fa-circle"></i> <a href="../the.great.escape/">Overview</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../the.great.escape/intro.html">Introduction</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../the.great.escape/reversing.html">Reverse Engineering</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../the.great.escape/discoveries.html">Discoveries</a></li>
  
  <li><i class="fa-li fa fa-circle"></i> <a href="../the.great.escape/c.html">C Port</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../the.great.escape/legals.html">Legals</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../the.great.escape/links.html">Links</a></li>
  
</ul>


    
<h1>Categories</h1>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../arm/">ARM</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../doodles/">Doodles</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../projects/">Projects</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../python/">Python</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../risc.os/">RISC&nbsp;OS</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../the.great.escape/">The&nbsp;Great&nbsp;Escape</a></li>
</ul>

    
<h1>Tags</h1>
<p><a href="../tags/Blog.html">Blog</a> <a href="../tags/RISC OS.html">RISC OS</a> <a href="../tags/PrivateEye.html">PrivateEye</a> <a href="../tags/PhotoFiler.html">PhotoFiler</a> <a href="../tags/IntroductionToARM.html">IntroductionToARM</a> <a href="../tags/Geminus.html">Geminus</a> <a href="../tags/Toolbar.html">Toolbar</a> <a href="../tags/Site.html">Site</a> <a href="../tags/Containers.html">Containers</a> <a href="../tags/GitHub.html">GitHub</a> <a href="../tags/Project.html">Project</a> <a href="../tags/Hardware.html">Hardware</a> <a href="../tags/iOS.html">iOS</a> <a href="../tags/Optimisation.html">Optimisation</a> <a href="../tags/Aha.html">Aha</a> <a href="../tags/Retro.html">Retro</a> <a href="../tags/Links.html">Links</a> <a href="../tags/Dump.html">Dump</a> <a href="../tags/Spectrum.html">Spectrum</a> <a href="../tags/Risc PC.html">Risc PC</a> <a href="../tags/The Great Escape.html">The Great Escape</a> <a href="../tags/LEGO.html">LEGO</a> <a href="../tags/Wedding.html">Wedding</a> <a href="../tags/Acorn.html">Acorn</a> <a href="../tags/Doodle.html">Doodle</a> <a href="../tags/Blender.html">Blender</a> <a href="../tags/3D.html">3D</a> <a href="../tags/Isometric.html">Isometric</a> <a href="../tags/2D.html">2D</a> <a href="../tags/Article.html">Article</a> <a href="../tags/ARM.html">ARM</a> <a href="../tags/Sinclair.html">Sinclair</a> <a href="../tags/Ocean.html">Ocean</a> <a href="../tags/Disassembly.html">Disassembly</a> <a href="../tags/Chase H.Q..html">Chase H.Q.</a> <a href="../tags/Tip.html">Tip</a> <a href="../tags/TargetedOptimisation.html">TargetedOptimisation</a> <a href="../tags/Trace.html">Trace</a> <a href="../tags/Hard Disc.html">Hard Disc</a> <a href="../tags/Vector.html">Vector</a> <a href="../tags/Archimedes.html">Archimedes</a> <a href="../tags/Logo.html">Logo</a> <a href="../tags/Recreation.html">Recreation</a> <a href="../tags/Pixel Art.html">Pixel Art</a> <a href="../tags/Groening.html">Groening</a> <a href="../tags/Simpsons.html">Simpsons</a> <a href="../tags/Futurama.html">Futurama</a> <a href="../tags/Disenchantment.html">Disenchantment</a> <a href="../tags/BBC Micro.html">BBC Micro</a> <a href="../tags/Electron.html">Electron</a> <a href="../tags/BasicOptimisation.html">BasicOptimisation</a> <a href="../tags/Slide.html">Slide</a> <a href="../tags/MotionMasks.html">MotionMasks</a> <a href="../tags/Script.html">Script</a> <a href="../tags/Python.html">Python</a> <a href="../tags/Iyonix.html">Iyonix</a> <a href="../tags/QuickFiler.html">QuickFiler</a> <a href="../tags/Game.html">Game</a> <a href="../tags/EfficientC.html">EfficientC</a> </p>


    
<h1>About me</h1>
<ul class="fa-ul">
  <li><i class="fa-li fas fa-user-astronaut"></i> David Thomas</li>
  <li><i class="fa-li fa fa-wrench"></i> Software Engineer</li>
  <li><i class="fa-li fas fa-map-pin"></i> Glasgow, Scotland</li>
</ul>

<h2>Contact</h2>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-envelope"></i> Email<br/> <a href="mailto:dave@davespace.co.uk">dave@davespace.co.uk</a></li>
  <li><i class="fa-li fab fa-github"></i> GitHub<br/> <a href="https://github.com/dpt">dpt</a></li>
  <li><i class="fa-li fab fa-youtube"></i> YouTube<br/> <a href="https://www.youtube.com/@bagospanners">@bagospanners</a></li>
  <li><i class="fa-li fab fa-soundcloud"></i> SoundCloud<br/> <a href="https://soundcloud.com/bagospanners">bagospanners</a></li>
</ul>

  </div>

<!-- start page -->

<!-- start post -->
<article>
  <header>
    <!-- start post header -->
    <h1><i class="fa fa-copyright"></i> The Great Escape > C Port</h1>
    
<!-- start meta -->
<div class="meta">
  by <span class="author">David Thomas</span> on <time datetime="2019-07-27T00:00:00Z">27 July 2019</time> &mdash;
  <ul>
    <li><i class="fa fa-tag"></i> <a href="../tags/GitHub.html">GitHub</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/Project.html">Project</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/Game.html">Game</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/The Great Escape.html">The Great Escape</a></li>

  </ul>
</div>
<!-- end meta -->

    <!-- end post header -->
  </header>

  
  <!-- start post content -->
  <section class="content">
    <h2>Table of Contents</h2>

<ol>
<li><a href="#no-longer-pseudo-code">No Longer Pseudo Code</a></li>
<li><a href="#pretend-spectrums">Pretend Spectrums</a></li>
<li><a href="#bringup">Bringup</a></li>
<li><a href="#portability">Portability</a></li>
<li><a href="#separation-of-state">Separation of State</a></li>
<li><a href="#on-randomness">On Randomness</a></li>
</ol>

<h2>No Longer Pseudo Code</h2>

<p>By February 2013 I understood the two routines <code>expand_object</code> and <code>plot_indoor_tiles</code> well enough so my thoughts turned to converting the pseudocode I&rsquo;d written in the disassembly into some C code.</p>

<p>But first a question: Why target ISO C instead of a higher-level language? Surely something like Python would be more suitable? In fact, my intention with the C port was <strong>not</strong> to create a portable C variant of the game. After all, if implemented accurately, the end result wouldn&rsquo;t be greatly different to playing the game via an emulator - which you can already do. So the C port really exists as proof of my disassembly&rsquo;s accuracy. If any of my understanding of the original game code is wrong then it&rsquo;s likely that the C version would screw up. So in order to move the minimum distance from the original assembly language while preserving the exact structure of the original game, I needed to use a language which can represent every mechanism it contained. That language has to be C.</p>

<p>For example, some leaf functions (functions which call no other) empty the stack and jump directly to the game&rsquo;s main loop. You can&rsquo;t represent that in many HLLs but I <em>can</em> in C by using the nonlocal jump functions <code>setjmp</code> and <code>longjmp</code>.</p>

<p>Even after choosing C there are numerous ways in which the code has to be <em>slightly bent</em> in order to exist. You can&rsquo;t have C functions with multiple entry points, for instance, nor can you fall off the end of a function into the start of another. Whereever a change like this was required in the C port I labelled it <code>/* Conv: ... */</code>.</p>

<h2>Pretend Spectrums</h2>

<p>A huge difference in the C version is that I&rsquo;m no longer coding for a bare metal ZX Spectrum. I needed to build a virtual, or abstract, ZX Spectrum model for it to run on. The hardware we need to simulate includes:</p>

<ul>
<li>The screen</li>
<li>The keyboard</li>
<li>The speaker</li>
</ul>

<p>The C version is coded to call out to a support library which provides emulated versions of these.</p>

<p>The original game runs exclusively so wasn&rsquo;t coded to be event driven, or to cooperate with other tasks/processes in any way. For this reason the C port runs the recreated game code in a thread. Although we can run the main game loop for a single iteration and yield to the OS after that, if we don&rsquo;t thread the game then it will fail to yield when it enters code that infinitely loops - which it does when waiting on user input, for instance when defining keys or on the pause screen.</p>

<h2>Bringup</h2>

<p>I proceeded with the conversion concurrently with the reverse engineering effort. By January 2016 I had enough parts in place to try to bringup the game.</p>

<p>The first run of the C port did not go to plan:</p>

<p><img src="tge/firstrun.png" alt="The Great Escape - first run"></p>

<p>The second quickly got things the right way around:</p>

<p><img src="tge/secondrun.png" alt="The Great Escape - second run"></p>

<p>And the third got things looking nearly normal:</p>

<p><img src="tge/thirdrun.png" alt="The Great Escape - third run"></p>

<p>After this stage it spent a whole lotta time crashing at startup&hellip;</p>

<h2>Portability</h2>

<p>As intended the C version is highly portable. I&rsquo;ve created front ends for macOS:</p>

<p><img src="tge/macos.png" alt="The Great Escape on macOS"></p>

<p>Windows:</p>

<p><img src="tge/windows.png" alt="The Great Escape on Windows"></p>

<p>and RISC OS:</p>

<p><img src="tge/riscos.png" alt="The Great Escape on RISC OS"></p>

<p>&hellip;admittedly to different levels of completion.</p>

<p>I&rsquo;ve also built a version using <a href="https://emscripten.org/">emscripten</a> which compiles C to JavaScript. <a href="http://www.davespace.co.uk/TheGreatEscape/TheGreatEscape.html">YMMV</a>. Use Kempston otherwise it&rsquo;ll lock up.</p>

<h2>Separation of State</h2>

<p>Rather than copying the original game&rsquo;s use of global variables, I encapsulated the game state in its own structure. Since each game is separated this makes it possible to fire up multiple games from the one parent app.</p>

<p>Here&rsquo;s one copy of the macOS port running 20 games at once. (Note: I recorded this forgetting about a rendering hack I had left in place&hellip;)</p>

<iframe width="544" height="408" src="https://www.youtube.com/embed/ZYqko6etxFk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h2>On Randomness</h2>

<p>As shown above, once the C port became suitably capable I was able to fire up multiple copies of the game simultaneously. I&rsquo;d coded the port to contain its entire state in a structure and pass that into virtually all functions - a typical approach experienced C developers use for robustness and to allow efficient multiple instantiation.</p>

<p>But something odd was going on: two games fired up immediately after one another were <strong>not</strong> behaving the same. The hero would perform the same initial actions - walking to the yard from his bedroom - but then would appear to take different directions when walking. Also in-game events were occurring at different times. Given that I&rsquo;d captured the game state as a structure and <em>knew</em> that I&rsquo;d reset that structure at the start of the game &hellip; <em>how</em> were the two games out of sync? An undefined variable flip-flopping? A rogue memory read? I did quite a bit of static analysis looking for these types of issues and could find no explanation.</p>

<p>After revisiting this repeatedly I finally realised what was happening. It turned out that I was mistaken about the <em>entire</em> game state being reset. One of the variables initialised before the menu screen runs is the <code>game_counter</code> cyclic counter (which counts 0..140 then repeats). This counter drives the game&rsquo;s events. And while the game waits on the menu screen, that variable is used by the morale flag waving code. When the game starts &lsquo;for real&rsquo; that counter <strong>isn&rsquo;t</strong> reset, but just carries on. So the amount of time spent on the menu screen is effectively a seed which randomises the timing of game events.</p>

<p>This is the case in the original game too: the length of time you spend on the main menu influences how your game plays out.</p>

<p>One piece of magic - explained.</p>

  </section>
  <!-- end post content -->

  
<!-- start flip -->

<div class="flip">
  <div class="previous">
    <i class="fa fa-arrow-alt-circle-left"></i> Previous topic: <a href="discoveries.html"> 
  
    Discoveries
  
</a>
  </div>
  <div class="next">
    <i class="fa fa-arrow-alt-circle-right"></i> Next topic: <a href="legals.html">
  
    Legals
  
</a>
  </div>
</div>

<!-- end flip -->

</article>
<!-- end post -->

<!-- end page -->

  <div id="footer">
    Copyright © David Thomas, 2005-2024<br/>
    Built using <i class="fab fa-github"></i> <a href="https://github.com/piranha/gostatic">gostatic</a> and <i class="fab fa-font-awesome-flag"></i> <a href="http://fontawesome.io/">Font Awesome</a>
  </div>
</body>
</html>

