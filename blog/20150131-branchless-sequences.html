
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="David Thomas">
  <meta name="keywords" content="DaveSpace, David Thomas, Dave Thomas">
  <meta name="description" content="David Thomas's website.">

  <title>Branchless Code Sequences | DaveSpace</title>

  <link rel="icon" type="image/vnd.microsoft.icon" href="../favicon.ico" />
  <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../favicon.ico" />

  <link rel="stylesheet" type="text/css" href="../style/flat.css">

  <link rel="alternate" type="application/atom+xml" title="DaveSpace feed" href="../blog.atom">

  <script src="https://kit.fontawesome.com/9bf331e7d1.js" crossorigin="anonymous"></script>
</head>
<body>

  <div id="header">
    <h1><i class="fas fa-user-astronaut"></i> <a href="../">DaveSpace</a></h1>
  </div>

  <div id="nav">
    

<h1>Recent Posts</h1>
<ul class="fa-ul">
  
  
  <li><i class="fa-li fa fa-bookmark"></i> <a href="../blog/20250517-lego-kit.html">A LEGO Kit for Blender</a></li>
  
  <li><i class="fa-li fa fa-bookmark"></i> <a href="../blog/20241223-archimedes-logo-redux.html">Archimedes Logo Recreation Redux</a></li>
  
  <li><i class="fa-li fa fa-bookmark"></i> <a href="../blog/20240518-marble-run-kit.html">A Marble Run Kit for Blender</a></li>
  
  <li><i class="fa-li fa fa-bookmark"></i> <a href="../blog/20230701-screen-cleaning.html">Dr. Dave's Patented Screen Cleaning Method*</a></li>
  
  <li><i class="fa-li fa fa-bookmark"></i> <a href="../blog/20230524-chase-hq-disassembly.html">Chase H.Q. disassembly project</a></li>
  
  
</ul>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-rss"></i> <a href="../blog.atom">Recent posts</a></li>
  <li><i class="fa-li fa fa-rss"></i> <a href="../blog-all.atom">All posts</a></li>
</ul>


    
<h1>Categories</h1>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../arm/">ARM</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../doodles/">Doodles</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../projects/">Projects</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../python/">Python</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../risc.os/">RISC&nbsp;OS</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../the.great.escape/">The&nbsp;Great&nbsp;Escape</a></li>
</ul>

    
<h1>Tags</h1>
<p><a href="../tags/ARM.html">ARM</a> <a href="../tags/Blog.html">Blog</a> <a href="../tags/RISC OS.html">RISC OS</a> <a href="../tags/PrivateEye.html">PrivateEye</a> <a href="../tags/PhotoFiler.html">PhotoFiler</a> <a href="../tags/Geminus.html">Geminus</a> <a href="../tags/IntroductionToARM.html">IntroductionToARM</a> <a href="../tags/Toolbar.html">Toolbar</a> <a href="../tags/Site.html">Site</a> <a href="../tags/Project.html">Project</a> <a href="../tags/Containers.html">Containers</a> <a href="../tags/GitHub.html">GitHub</a> <a href="../tags/Hardware.html">Hardware</a> <a href="../tags/iOS.html">iOS</a> <a href="../tags/Optimisation.html">Optimisation</a> <a href="../tags/Aha.html">Aha</a> <a href="../tags/Retro.html">Retro</a> <a href="../tags/Links.html">Links</a> <a href="../tags/Dump.html">Dump</a> <a href="../tags/Spectrum.html">Spectrum</a> <a href="../tags/Risc PC.html">Risc PC</a> <a href="../tags/The Great Escape.html">The Great Escape</a> <a href="../tags/Reverse Engineering.html">Reverse Engineering</a> <a href="../tags/LEGO.html">LEGO</a> <a href="../tags/Wedding.html">Wedding</a> <a href="../tags/Acorn.html">Acorn</a> <a href="../tags/Doodle.html">Doodle</a> <a href="../tags/Blender.html">Blender</a> <a href="../tags/3D.html">3D</a> <a href="../tags/Isometric.html">Isometric</a> <a href="../tags/2D.html">2D</a> <a href="../tags/Article.html">Article</a> <a href="../tags/Sinclair.html">Sinclair</a> <a href="../tags/Ocean.html">Ocean</a> <a href="../tags/Disassembly.html">Disassembly</a> <a href="../tags/Chase H.Q..html">Chase H.Q.</a> <a href="../tags/Tip.html">Tip</a> <a href="../tags/TargetedOptimisation.html">TargetedOptimisation</a> <a href="../tags/Archimedes.html">Archimedes</a> <a href="../tags/Logo.html">Logo</a> <a href="../tags/BasicOptimisation.html">BasicOptimisation</a> <a href="../tags/Slide.html">Slide</a> <a href="../tags/Trace.html">Trace</a> <a href="../tags/Hard Disc.html">Hard Disc</a> <a href="../tags/Vector.html">Vector</a> <a href="../tags/Recreation.html">Recreation</a> <a href="../tags/Pixel Art.html">Pixel Art</a> <a href="../tags/Groening.html">Groening</a> <a href="../tags/Simpsons.html">Simpsons</a> <a href="../tags/Futurama.html">Futurama</a> <a href="../tags/Disenchantment.html">Disenchantment</a> <a href="../tags/BBC Micro.html">BBC Micro</a> <a href="../tags/Electron.html">Electron</a> <a href="../tags/MotionMasks.html">MotionMasks</a> <a href="../tags/Script.html">Script</a> <a href="../tags/Python.html">Python</a> <a href="../tags/Iyonix.html">Iyonix</a> <a href="../tags/QuickFiler.html">QuickFiler</a> <a href="../tags/Game.html">Game</a> <a href="../tags/EfficientC.html">EfficientC</a> </p>


    
<h1>About me</h1>
<ul class="fa-ul">
  <li><i class="fa-li fas fa-user-astronaut"></i> David Thomas</li>
  <li><i class="fa-li fa fa-wrench"></i> Software Engineer</li>
  <li><i class="fa-li fas fa-map-pin"></i> Glasgow, Scotland</li>
</ul>

<h2>Contact</h2>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-envelope"></i> Email<br/> <a href="mailto:dave@davespace.co.uk">dave@davespace.co.uk</a></li>
  <li><i class="fa-li fab fa-github"></i> GitHub<br/> <a href="https://github.com/dpt">dpt</a></li>
  <li><i class="fa-li fab fa-youtube"></i> YouTube<br/> <a href="https://www.youtube.com/@bagospanners">@bagospanners</a></li>
</ul>

  </div>

<!-- start page -->

<!-- start post -->
<article>
  <header>
    <!-- start post header -->
    <h1><i class="fa fa-microchip"></i> Branchless Code Sequences</h1>
    
<!-- start meta -->
<div class="meta">
  by <span class="author">David Thomas</span> on <time datetime="2015-01-31T00:00:00Z">31 January 2015</time> &mdash;
  <ul>
    <li><i class="fa fa-tag"></i> <a href="../tags/Blog.html">Blog</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/Optimisation.html">Optimisation</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/EfficientC.html">EfficientC</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/GitHub.html">GitHub</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/Project.html">Project</a></li>
<li><i class="fa fa-tag"></i> <a href="../tags/Aha.html">Aha</a></li>

  </ul>
</div>
<!-- end meta -->

    <!-- end post header -->
  </header>

  
  <!-- start post content -->
  <section class="content">
    <h2>Overview</h2>

<!-- begin summary -->

<p>Sometimes when low-level programming we need to tune a small code sequence which is critical to an implementation. For example, an inner loop in a graphics routine may involve a pixel-bashing operation that dominates the program&rsquo;s overall performance. If this operation uses a comparison that results in the compiled code branching it may hurt performance on pipelined CPUs. It might offer higher performance to replace the sequence with a branch-free alternative, even if it makes the code more complicated.</p>

<p>But how do we find these branch-free alternatives? Sufficiently small sequences can be discovered with a <em>superoptimiser</em> program. Superoptimisers are not as clever as the name might suggest: they are typically an exhaustive search through an (often virtual) instruction set. The superoptimiser will try every conceivable permutation of instructions from its instruction set until it finds a sequence which works for the values under test.</p>

<p>Two examples of this are <a href="http://directory.fsf.org/wiki/Superopt">GNU superopt</a> (1995) and <a href="http://www.hackersdelight.org/">Aha! - A Hacker&rsquo;s Assistant</a> (2008). In this article I&rsquo;ll discuss Aha.</p>

<!-- end summary -->

<h3>A Hacker&rsquo;s Assistant</h3>

<p>Aha was written by Henry S. Warren, Jr. author of the indispensable book on bit twiddling: <a href="http://www.amazon.co.uk/gp/product/0321842685/">Hacker&rsquo;s Delight</a>.</p>

<p>Aha exhaustively tries all reasonable combinations of instructions from a customisable set. The instruction set corresponds to no real CPU but is sufficiently general and RISC-like to be applicable to most CPUs. It simulates 32-bit calculations only and knows nothing about processor flags.</p>

<p>I maintain <a href="https://github.com/dpt/Aha">a version of Aha on Github</a> which includes a couple of straightforward tweaks to make it more interesting for 32-bit mode ARM CPUs. Additions I&rsquo;ve made to its repertoire include adding an equivalent of ARM&rsquo;s <em>bitwise clear</em> <code>BIC</code> instruction (equivalent to <code>AND NOT</code>) and <em>reverse subtract</em> <code>RSB</code>.</p>

<h3>An example</h3>

<p>First, clone and enter the Aha repo:</p>

<div class="highlight"><pre>$ git clone git@github.com:dpt/Aha.git
$ cd Aha
</pre></div>

<p>
Let&rsquo;s cook up an illustrative although perhaps useless operation to be built into Aha for testing. The operation must be ‘pure’: having no side effects or reliance on global state.</p>

<p>Our test operation will return one if <code>x</code> is zero. If <code>x</code> is one, it will return two. Otherwise it will return zero.</p>

<div class="highlight"><pre><span></span><span class="cm">/* test.frag.c */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;aha.h&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">userfun</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span><span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>We&rsquo;ll build the Aha binary, linking in our user function by specifying <code>EXAMPLE=test</code>. With only a few source files it&rsquo;s quick to build:</p>

<div class="highlight"><pre>$ make EXAMPLE=test aha
gcc -c -O2 -Wall -Wno-unused-variable -MMD -I. -DINC=\"test.frag.c\" -DOFILE=\"test.out\" -o aha.o aha.c
gcc -c -O2 -Wall -Wno-unused-variable -MMD -I. -DINC=\"test.frag.c\" -DOFILE=\"test.out\" -o simulator.o simulator.c
gcc -O2 -Wall -Wno-unused-variable -MMD -I. -DINC=\"test.frag.c\" -DOFILE=\"test.out\" -o aha aha.o simulator.o
</pre></div>

<p>We invoke Aha with the length of instruction sequence to trial. For our first attempt let&rsquo;s see if there are any programs which can calculate our illustrative operation in three Aha operations:</p>

<div class="highlight"><pre>$ ./aha 3
Searching for programs with 3 operations.
Found 0 solutions.
Counters = 372751, 382255, 952561, total = 1707567
Process time = 0.029 secs
</pre></div>

<p>Nope&hellip; Okay, let&rsquo;s try four instructions:</p>

<div class="highlight"><pre>$ ./aha 4
Searching for programs with 4 operations.

Found a 4-operation program:
   add   r1,rx,-2
   bic   r2,r1,rx
   shr   r3,r2,31
   shl   r4,r3,rx
   Expr: ((((x + -2) & ~x) >>u 31) << x)

Found a 4-operation program:
   sub   r1,rx,2
   bic   r2,r1,rx
   shr   r3,r2,31
   shl   r4,r3,rx
   Expr: ((((x - 2) & ~x) >>u 31) << x)

Found a 4-operation program:
   shr   r1,rx,1
   sub   r2,r1,1
   shr   r3,r2,31
   shl   r4,r3,rx
   Expr: ((((x >>u 1) - 1) >>u 31) << x)

Found a 4-operation program:
   shr   r1,rx,1
   sub   r2,0x80000000,r1
   shr   r3,r2,31
   shl   r4,r3,rx
   Expr: (((0x80000000 - (x >>u 1)) >>u 31) << x)
Found 4 solutions.
Counters = 71688592, 71698096, 73956616, 196050676, total = 413393980
Process time = 6.240 secs
</pre></div>

<p>Great! This run has given us four suggested solutions:</p>

<ul>
<li><code>(((x + -2) &amp; ~x) &gt;&gt;u 31) &lt;&lt; x</code></li>
<li><code>(((x - 2) &amp; ~x) &gt;&gt;u 31) &lt;&lt; x</code></li>
<li><code>(((x &gt;&gt;u 1) - 1) &gt;&gt;u 31) &lt;&lt; x</code></li>
<li><code>((0x80000000 - (x &gt;&gt;u 1)) &gt;&gt;u 31) &lt;&lt; x</code></li>
</ul>

<p>Observe that Aha&rsquo;s notation uses <code>&gt;&gt;u</code> to denote unsigned right shifts. It will also emit <code>&gt;&gt;s</code> for signed right shifts.</p>

<p>The first two suggestions are <code>(((x + -2) &amp; ~x) &gt;&gt;u 31) &lt;&lt; x</code> and <code>(((x - 2) &amp; ~x) &gt;&gt;u 31) &lt;&lt; x</code> which only differ by the sub-expressions (x + -2) and (x - 2). These are of course the same thing, but since instruction-wise they&rsquo;re different operations to Aha it outputs them both. (You might discard these variations immediately when approaching from an optimisation perspective but they were actually valuable to me when I was generating random equivalent instruction sequences for anti-tamper software in a former role.)</p>

<h3>It&rsquo;s not <em>exhaustively</em> exhaustive</h3>

<p>To verify that a sequence works Aha runs it against a limited set of constants. The define <code>TRIAL</code> in Aha&rsquo;s <code>config.h</code> enumerates them:</p>

<div class="highlight"><pre><span></span><span class="cp">#define TRIAL {1, 0, -1, \</span>
<span class="cp">               MAXNEG, MAXPOS, MAXNEG + 1, MAXPOS - 1, \</span>
<span class="cp">               0x01234567, 0x89ABCDEF, -2, 2, -3, 3, -64, 64, -5, -31415, \</span>
<span class="cp">               0x0000FFFF, 0xFFFF0000, \</span>
<span class="cp">               0x000000FF, 0x0000FF00, 0x00FF0000, 0xFF000000, \</span>
<span class="cp">               0x0000000F, 0x000000F0, 0x00000F00, 0x0000F000, \</span>
<span class="cp">               0x000F0000, 0x00F00000, 0x0F000000, 0xF0000000}</span>
</pre></div>

<p>You could make Aha more accurate by adding to this list, but extending it too much will slow things down. Conversely you could remove some trial values from here if you only care about your solution working for a subset of integers, such as bytes.</p>

<p>While Aha performs an exhaustive <em>search</em> for answers it does <strong>not</strong> perform an exhaustive <em>test</em> of its suggestions. If you want a generated program to be proven working for all possible input values (e.g. all 32-bit integers, or the subset of integer values that matter to you) then you&rsquo;ll need to write a small test program yourself.</p>

<p>So let&rsquo;s build that small test program in C and verify that each of the suggested programs works for every possible 32-bit integer:</p>

<div class="highlight"><pre><span></span><span class="cm">/* test.c -- test shell for Aha! suggested solutions */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">T</span><span class="p">;</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="n">testfn_t</span><span class="p">)(</span><span class="n">T</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cm">/* reference version of our original operation */</span><span class="w"> </span>
<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">reference</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">branchless1</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(((</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">-2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">branchless2</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(((</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">branchless3</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(((</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">branchless4</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">testfn_t</span><span class="w"> </span><span class="o">*</span><span class="n">branchless</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reference</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">tests</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="n">branchless1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reference</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="n">branchless2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reference</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="n">branchless3</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reference</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="n">branchless4</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reference</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cp">#define NELEMS(a) (int)(sizeof(a) / sizeof(a[0]))</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">          </span><span class="n">j</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NELEMS</span><span class="p">(</span><span class="n">tests</span><span class="p">);</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">testfn_t</span><span class="w"> </span><span class="o">*</span><span class="n">fn</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ref</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w">       </span><span class="n">nfailures</span><span class="p">;</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;starting test %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span>

<span class="w">        </span><span class="n">fn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">tests</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">branchless</span><span class="p">;</span>
<span class="w">        </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tests</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">reference</span><span class="p">;</span>

<span class="w">        </span><span class="n">nfailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* test all values from zero to UINT_MAX */</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ref</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">nfailures</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="cm">/* report first twenty failures only */</span>
<span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;failure at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x03ffffff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="cm">/* draw 64 dots */</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">putc</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="p">);</span>
<span class="w">                </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UINT_MAX</span><span class="p">)</span><span class="w"> </span><span class="cm">/* test here to prevent infinite loop */</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nfailures</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;all ok!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;saw %d failures</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nfailures</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Build and run it:</p>

<div class="highlight"><pre>$ gcc -Wall -O3 test.c -o test
$ ./test
starting test 0
................................................................
all ok!
starting test 1
................................................................
all ok!
starting test 2
................................................................
all ok!
starting test 3
................................................................
all ok!
</pre></div>

<p>Everything works. Cool! Now you get to plug it into your code to see if it speeds things up.</p>

<h2>Some useful sequences I&rsquo;ve found using Aha</h2>

<h3>Absolute value</h3>

<p>To calculate <code>x &gt;= 0 ? x : -x</code>, try:</p>

<ul>
<li><code>((x &gt;&gt;s 31) ^ x) - (x &gt;&gt;s 31)</code>, or</li>
<li><code>((x &gt;&gt;s 31) + x) ^ (x &gt;&gt;s 31)</code></li>
</ul>

<p>Of course we can pull the constant term <code>s</code> <code>(x &gt;&gt;s 31)</code> out from these and have:</p>

<ul>
<li><code>(s ^ x) - s</code>, or</li>
<li><code>(s + x) ^ s</code></li>
</ul>

<p>See <a href="https://hbfs.wordpress.com/2008/08/05/branchless-equivalents-of-simple-functions/">this article</a> from <a href="https://hbfs.wordpress.com/">Harder, Better, Faster, Stronger</a>  for similar.</p>

<h3>Coerce to boolean</h3>

<p>To calculate <code>!!x</code> (which coerces a variable to a bool), try:</p>

<ul>
<li><code>(-(x) | x) &gt;&gt;u 31</code>, or</li>
<li><code>((x &gt;&gt;u 1) - x) &gt;&gt;u 31</code></li>
</ul>

<p>I researched this case, and the following ones, after discovering that a large game vendor&rsquo;s compiler was inserting a needless branch when a cast to bool was added. Replacing the cast with one of these solved the issue. Sometimes even inbuilt operators can result in unexpected, redundant branches.</p>

<h3>Coerce to inverted boolean</h3>

<p>To calculate <code>!x</code>, try:</p>

<ul>
<li><code>((x - 1) &amp; ~x) &gt;&gt;u 31</code>, or</li>
<li><code>((x - 1) &amp; ~x) &gt;&gt;u (x - 1)</code>, or</li>
<li><code>((x - 1) &amp; ~x) &gt;&gt;u ((x - 1) &amp; ~x)</code>, or</li>
<li><code>((0x80000000 - x) &amp; ~x) &gt;&gt;u 31</code></li>
</ul>

<h3>Coerce to boolean where true is negative one</h3>

<p>To calculate <code>x ? -1 : 0</code>, try:</p>

<ul>
<li><code>(-(x) | x) &gt;&gt;s 31</code>, or</li>
<li><code>((x &gt;&gt;u 1) - x) &gt;&gt;s 31</code></li>
</ul>

<h2>References</h2>

<ul>
<li><a href="http://www.hackersdelight.org/aha/aha.pdf">Aha&rsquo;s manual</a> (Henry Warren, 2008)</li>
<li><a href="https://hbfs.wordpress.com/2008/08/05/branchless-equivalents-of-simple-functions/">Branchless Equivalents of Simple Functions</a> (Steven Pigeon, 2008)</li>
</ul>

<h2>Links</h2>

<ul>
<li><a href="http://www.ic.unicamp.br/~celio/mc404-2013/arm-examples/division/div.c">ARM&rsquo;s <code>divc.c</code> optimal divide-by-constant code generator</a> (ARM, 1994)</li>
<li><a href="http://gcc.godbolt.org/">Interactive compiler</a> (Matt Godbolt)</li>
<li><a href="http://superoptimization.org/wiki/Superoptimizing_Compilers">Superoptimizing Compilers - feasibility study</a> (Embecosm)</li>
<li><a href="https://github.com/nickgildea/z3_codegen">Z3 Code Generator</a></li>
</ul>

<h2>Changelog</h2>

<ul>
<li>2020-0802

<ul>
<li>Fix a glaring typo, various edits</li>
</ul></li>
<li>2019-11-19

<ul>
<li>Edits for readability</li>
</ul></li>
</ul>

  </section>
  <!-- end post content -->

  
<!-- start flip -->

<!-- end flip -->

</article>
<!-- end post -->

<!-- end page -->

  <div id="footer">
    Copyright © David Thomas, 2005-2025<br/>
    Built using <i class="fab fa-github"></i> <a href="https://github.com/piranha/gostatic">gostatic</a> and <i class="fab fa-font-awesome-flag"></i> <a href="http://fontawesome.io/">Font Awesome</a>
  </div>
</body>
</html>

