
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="David Thomas">
  <meta name="keywords" content="DaveSpace, David Thomas, Dave Thomas">
  <meta name="description" content="David Thomas's website.">

  <title>ARM: Efficient C for ARM: Data Drive | DaveSpace</title>

  <link rel="icon" type="image/vnd.microsoft.icon" href="../../favicon.ico" />
  <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../../favicon.ico" />

  <link rel="stylesheet" type="text/css" href="../../style/flat.css">

  <link rel="alternate" type="application/atom+xml" title="DaveSpace feed" href="../../blog.atom">

  <script src="https://kit.fontawesome.com/9bf331e7d1.js" crossorigin="anonymous"></script>
</head>
<body id="arm">

  <div id="header">
    <h1><i class="fas fa-user-astronaut"></i> <a href="../../">DaveSpace</a></h1>
  </div>

  <div id="nav">
    

<h1>ARM &gt; <br/>Efficient C for ARM</h1>
<ul class="fa-ul">
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/">Start</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/efficiency.html">Efficiency</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/before-tuning.html">Before Tuning...</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/optimising.html">Optimising</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/profilers.html">Profilers</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/slow.html">Stuff That’s Slow on ARM</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/fp.html">Floating Point</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/division.html">Division and Modulus</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/unaligned.html">Unaligned Data Access</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/bools.html">Bools</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/bitfields.html">Bitfields</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/padding.html">Padding</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/hoisting.html">Hoisting</a></li>
  
  <li><i class="fa-li fa fa-circle"></i> <a href="../../arm/efficient-c-for-arm/datadrive.html">Data Drive</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/indexing.html">Avoid Array Indexing</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/aliasing.html">Pointer Aliasing</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/chains.html">Pointer Chains</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/sentinels.html">Sentinels</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/unrolling.html">Loop Unrolling</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/datatypes.html">C Data Types</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/memaccess.html">Memory Access</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/localvar.html">Local Variable Types</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/funcarg.html">Function Argument Types</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/varaddr.html">Taking a Variable’s Address</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/loops.html">Looping Structures</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/regalloc.html">Register Allocation</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/func.html">Function Calls</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/smallfunc.html">Small Functions</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/biasing.html">Biasing Values</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/unsignedrange.html">Unsigned Ranges</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/baseptr.html">Base Pointer Optimisation</a></li>
  
  <li><i class="fa-li far fa-circle"></i> <a href="../../arm/efficient-c-for-arm/references.html">References</a></li>
  
</ul>


    
<h1>Categories</h1>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../../arm/">ARM</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../../doodles/">Doodles</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../../projects/">Projects</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../../python/">Python</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../../risc.os/">RISC&nbsp;OS</a></li>
  <li><i class="fa-li fa fa-chevron-circle-right"></i> <a href="../../the.great.escape/">The&nbsp;Great&nbsp;Escape</a></li>
</ul>

    
<h1>Tags</h1>
<p><a href="../../tags/ARM.html">ARM</a> <a href="../../tags/Blog.html">Blog</a> <a href="../../tags/RISC OS.html">RISC OS</a> <a href="../../tags/PrivateEye.html">PrivateEye</a> <a href="../../tags/PhotoFiler.html">PhotoFiler</a> <a href="../../tags/IntroductionToARM.html">IntroductionToARM</a> <a href="../../tags/Geminus.html">Geminus</a> <a href="../../tags/Toolbar.html">Toolbar</a> <a href="../../tags/Site.html">Site</a> <a href="../../tags/Project.html">Project</a> <a href="../../tags/Containers.html">Containers</a> <a href="../../tags/GitHub.html">GitHub</a> <a href="../../tags/Hardware.html">Hardware</a> <a href="../../tags/iOS.html">iOS</a> <a href="../../tags/Optimisation.html">Optimisation</a> <a href="../../tags/Aha.html">Aha</a> <a href="../../tags/Retro.html">Retro</a> <a href="../../tags/Links.html">Links</a> <a href="../../tags/Dump.html">Dump</a> <a href="../../tags/Spectrum.html">Spectrum</a> <a href="../../tags/Risc PC.html">Risc PC</a> <a href="../../tags/The Great Escape.html">The Great Escape</a> <a href="../../tags/Reverse Engineering.html">Reverse Engineering</a> <a href="../../tags/LEGO.html">LEGO</a> <a href="../../tags/Wedding.html">Wedding</a> <a href="../../tags/Acorn.html">Acorn</a> <a href="../../tags/Doodle.html">Doodle</a> <a href="../../tags/Blender.html">Blender</a> <a href="../../tags/3D.html">3D</a> <a href="../../tags/Isometric.html">Isometric</a> <a href="../../tags/2D.html">2D</a> <a href="../../tags/Article.html">Article</a> <a href="../../tags/Sinclair.html">Sinclair</a> <a href="../../tags/Ocean.html">Ocean</a> <a href="../../tags/Disassembly.html">Disassembly</a> <a href="../../tags/Chase H.Q..html">Chase H.Q.</a> <a href="../../tags/TargetedOptimisation.html">TargetedOptimisation</a> <a href="../../tags/Tip.html">Tip</a> <a href="../../tags/BasicOptimisation.html">BasicOptimisation</a> <a href="../../tags/Archimedes.html">Archimedes</a> <a href="../../tags/Logo.html">Logo</a> <a href="../../tags/Slide.html">Slide</a> <a href="../../tags/Trace.html">Trace</a> <a href="../../tags/Hard Disc.html">Hard Disc</a> <a href="../../tags/Vector.html">Vector</a> <a href="../../tags/Recreation.html">Recreation</a> <a href="../../tags/Pixel Art.html">Pixel Art</a> <a href="../../tags/Groening.html">Groening</a> <a href="../../tags/Simpsons.html">Simpsons</a> <a href="../../tags/Futurama.html">Futurama</a> <a href="../../tags/Disenchantment.html">Disenchantment</a> <a href="../../tags/BBC Micro.html">BBC Micro</a> <a href="../../tags/Electron.html">Electron</a> <a href="../../tags/MotionMasks.html">MotionMasks</a> <a href="../../tags/Script.html">Script</a> <a href="../../tags/Python.html">Python</a> <a href="../../tags/Iyonix.html">Iyonix</a> <a href="../../tags/QuickFiler.html">QuickFiler</a> <a href="../../tags/Game.html">Game</a> <a href="../../tags/EfficientC.html">EfficientC</a> </p>


    
<h1>About me</h1>
<ul class="fa-ul">
  <li><i class="fa-li fas fa-user-astronaut"></i> David Thomas</li>
  <li><i class="fa-li fa fa-wrench"></i> Software Engineer</li>
  <li><i class="fa-li fas fa-map-pin"></i> Glasgow, Scotland</li>
</ul>

<h2>Contact</h2>
<ul class="fa-ul">
  <li><i class="fa-li fa fa-envelope"></i> Email<br/> <a href="mailto:dave@davespace.co.uk">dave@davespace.co.uk</a></li>
  <li><i class="fa-li fab fa-github"></i> GitHub<br/> <a href="https://github.com/dpt">dpt</a></li>
  <li><i class="fa-li fab fa-youtube"></i> YouTube<br/> <a href="https://www.youtube.com/@bagospanners">@bagospanners</a></li>
  <li><i class="fa-li fab fa-soundcloud"></i> SoundCloud<br/> <a href="https://soundcloud.com/bagospanners">bagospanners</a></li>
</ul>

  </div>

<!-- start page -->

<!-- start post -->
<article>
  <header>
    <!-- start post header -->
    <h1><i class="fa fa-microchip"></i> ARM > Efficient C for ARM > Data Drive</h1>
    
<!-- start meta -->
<div class="meta">
  by <span class="author">David Thomas</span> on <time datetime="2012-03-03T00:00:00Z">03 March 2012</time> &mdash;
  <ul>
    <li><i class="fa fa-tag"></i> <a href="../../tags/ARM.html">ARM</a></li>
<li><i class="fa fa-tag"></i> <a href="../../tags/EfficientC.html">EfficientC</a></li>
<li><i class="fa fa-tag"></i> <a href="../../tags/Slide.html">Slide</a></li>
<li><i class="fa fa-tag"></i> <a href="../../tags/BasicOptimisation.html">BasicOptimisation</a></li>

  </ul>
</div>
<!-- end meta -->

    <!-- end post header -->
  </header>

  
  <!-- start post content -->
  <section class="content">
    <section>
<div class="slide">

<h2>Data Drive</h2>

<ul>
<li>Avoid mixing code and data together.</li>
<li>Instead separate out the data and write a simple loop.</li>
<li>Doing this generates less code.</li>
</ul>

</div>
</section>
<section>
<div class="examples">

<h2>Examples</h2>

<p>The following simple routine maps a name to a number:</p>

<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">nameToNumber</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w">      </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">)</span><span class="w">   </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Paul&quot;</span><span class="p">)</span><span class="w">   </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;George&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Ringo&quot;</span><span class="p">)</span><span class="w">  </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default case */</span>
<span class="p">}</span>
</pre></div>

<p>Because each case is written out individually, the compiler will emit code for
every individual case:</p>

<div class="highlight"><pre><span class="nf">nameToNumber</span>
        <span class="k">STMFD</span>    sp!,{r4,lr}
        <span class="k">MOV</span>      r4,r0       <span class="c1">; name</span>
        <span class="k">ADR</span>      r1,|L1.104| <span class="c1">; "John"</span>
        <span class="k">BL</span>       strcmp
        <span class="k">CMP</span>      r0,<span class="mi">#0</span>       <span class="c1">; yes?</span>
        <span class="k">MOVEQ</span>    r0,<span class="mi">#5</span>       <span class="c1">; retval</span>
        <span class="k">LDMEQFD</span>  sp!,{r4,pc} <span class="c1">; return</span>
        <span class="k">MOV</span>      r0,r4       <span class="c1">; name</span>
        <span class="k">ADR</span>      r1,|L1.112| <span class="c1">; "Paul"</span>
        <span class="k">BL</span>       strcmp
        <span class="k">CMP</span>      r0,<span class="mi">#0</span>       <span class="c1">; yes?</span>
        <span class="k">MOVEQ</span>    r0,<span class="mi">#2</span>       <span class="c1">; retval</span>
        <span class="k">LDMEQFD</span>  sp!,{r4,pc} <span class="c1">; return</span>
        <span class="c1">; ... more for each case ...</span>
</pre></div>

<p>That’s 26 instructions × 4 bytes = <strong>104 bytes</strong>.</p>

<p>If we generalise the code, storing the data in a table which maps the input
names to output numbers, then we can save a significant amount of code:</p>

<div class="highlight"><pre><span></span><span class="cp">#define NELEMS(a) ((int) (sizeof(a) / sizeof(a[0])))</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">nameToNumber2</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span><span class="w"> </span><span class="cm">/* NB. PIC */</span>
<span class="w">        </span><span class="kt">int</span><span class="w">        </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">map</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">,</span><span class="w">   </span><span class="mi">5</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Paul&quot;</span><span class="p">,</span><span class="w">   </span><span class="mi">2</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;George&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Ringo&quot;</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NELEMS</span><span class="p">(</span><span class="n">map</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default case */</span>
<span class="p">}</span>
</pre></div>

<p>Compiles to:</p>

<div class="highlight"><pre><span class="nf">nameToNumber2</span>   <span class="k">STMFD</span>    sp!,{r4-r6,lr}
                <span class="k">LDR</span>      r6,=mapaddr     <span class="c1">; address of 'map'</span>
                <span class="k">MOV</span>      r5,r0           <span class="c1">; stash copy of name</span>
                <span class="k">MOV</span>      r4,<span class="mi">#0</span>           <span class="c1">; i</span>
<span class="nf">loop</span>            <span class="k">ADD</span>      r0,r4,r4,<span class="k">LSL</span> <span class="mi">#1</span> 
                <span class="k">ADD</span>      r1,r6,r0,<span class="k">LSL</span> <span class="mi">#2</span> <span class="c1">; map + i*12</span>
                <span class="k">MOV</span>      r0,r5           <span class="c1">; = name</span>
                <span class="k">BL</span>       strcmp
                <span class="k">CMP</span>      r0,<span class="mi">#0</span>           <span class="c1">; match?</span>
                <span class="k">ADDEQ</span>    r0,r4,r4,<span class="k">LSL</span> <span class="mi">#1</span> <span class="c1">; yes</span>
                <span class="k">ADDEQ</span>    r0,r6,r0,<span class="k">LSL</span> <span class="mi">#2</span> <span class="c1">; map + i*12 again</span>
                <span class="k">LDREQ</span>    r0,[r0,<span class="mi">#8</span>]      <span class="c1">; fetch map[i].value</span>
                <span class="k">LDMEQFD</span>  sp!,{r4-r6,pc}  <span class="c1">; return it</span>
                <span class="k">ADD</span>      r4,r4,<span class="mi">#1</span>        <span class="c1">; otherwise no match</span>
                <span class="k">CMP</span>      r4,<span class="mi">#4</span>           <span class="c1">; loop until out..</span>
                <span class="k">BLT</span>      loop            <span class="c1">; ..of data</span>
                <span class="k">MVN</span>      r0,<span class="mi">#0</span>
                <span class="k">LDMFD</span>    sp!,{r4-r6,pc}  <span class="c1">; return -1</span>
</pre></div>

<p>Which is 18 instructions × 4 bytes = <strong>72 bytes</strong>, saving of 32 bytes.</p>
</div>
</section>

  </section>
  <!-- end post content -->

  
<!-- start flip -->

<div class="flip">
  <div class="previous">
    <i class="fa fa-arrow-alt-circle-left"></i> Previous topic: <a href="hoisting.html"> 
  
    Hoisting
  
</a>
  </div>
  <div class="next">
    <i class="fa fa-arrow-alt-circle-right"></i> Next topic: <a href="indexing.html">
  
    Avoid Array Indexing
  
</a>
  </div>
</div>

<!-- end flip -->

</article>
<!-- end post -->

<!-- end page -->

  <div id="footer">
    Copyright © David Thomas, 2005-2024<br/>
    Built using <i class="fab fa-github"></i> <a href="https://github.com/piranha/gostatic">gostatic</a> and <i class="fab fa-font-awesome-flag"></i> <a href="http://fontawesome.io/">Font Awesome</a>
  </div>
</body>
</html>

